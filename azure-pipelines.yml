# Docker
# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
  - master

resources:
  - repo: self

variables:
  # Container registry service connection established during pipeline creation
  dockerRegistryServiceConnection: "f89f2b61-fa2e-4553-aa16-ed18f3b095aa"
  imageRepository: "ralph-storefront"
  containerRegistry: "ralphregistry.azurecr.io"
  dockerfilePath: "$(Build.SourcesDirectory)/Dockerfile"
  tag: "$(Build.BuildId)"
  deploymentManifest: "deployment-*.yml"

  # Agent VM image name
  vmImageName: "ubuntu-latest"

stages:
  - stage: Build
    displayName: Build and push stage
    jobs:
      - job: Build
        displayName: Build
        pool:
          vmImage: $(vmImageName)
        steps:
          - task: Docker@2
            displayName: Build and push an image to container registry
            inputs:
              command: buildAndPush
              repository: $(imageRepository)
              dockerfile: $(dockerfilePath)
              containerRegistry: $(dockerRegistryServiceConnection)
              tags: |
                $(tag)
          - task: PowerShell@2
            displayName: "Replace ##BUILD_ID in deployment manifest"
            inputs:
              targetType: inline
              script: |
                $configFiles = Get-ChildItem .\k8s $(deploymentManifest) -rec
                foreach ($file in $configFiles)
                {
                    (Get-Content $file.PSPath) |
                    Foreach-Object { $_ -replace "##BUILD_ID", "$(tag)" } |
                    Set-Content $file.PSPath
                }
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: "$(Build.SourcesDirectory)/k8s"
              ArtifactName: "drop"
              publishLocation: "Container"
